<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solar Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;background:#f4f6fb;padding:15px;}
.cards{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;}
.card{color:#fff;padding:15px;border-radius:12px;text-align:center;font-weight:bold;}
.card:nth-child(1){background:#4caf50;}
.card:nth-child(2){background:#2196f3;}
.card:nth-child(3){background:#ff9800;}
.card:nth-child(4){background:#9c27b0;}
.card:nth-child(5){background:#f44336;}
.charts{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.chartBox{background:#fff;padding:15px;border-radius:14px;box-shadow:0 4px 10px rgba(0,0,0,.1);}
</style>
</head>

<body>

<h2>Solar Plant Dashboard</h2>

<div style="margin-bottom:10px;">
  <b>Financial Year:</b>
  <select id="fySelect" onchange="renderDashboard()"></select>
</div>

<div class="cards">
  <div class="card">Today<br><span id="todayGen">0</span></div>
  <div class="card">Yesterday<br><span id="yesterdayGen">0</span></div>
  <div class="card">Month Gen<br><span id="monthGen">0</span></div>
  <div class="card">Year Gen<br><span id="yearGen">0</span></div>
  <div class="card">Avg PR<br><span id="avgPR">0</span></div>
</div>

<div class="charts">
  <div class="chartBox">
    <h4>Daily Generation (Current Month)</h4>
    <canvas id="dailyChart"></canvas>
  </div>
  <div class="chartBox">
    <h4>Monthly Generation (Financial Year)</h4>
    <canvas id="monthlyChart"></canvas>
  </div>
</div>

<script>
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/1Y3cr91xEEQj86B9hXMYdpp6UU1a33-vlrFcWKkLRujg/gviz/tq?tqx=out:json&gid=861206775";

let rows=[],dailyChart=null,monthlyChart=null;

// -------- DATE PARSE --------
function parseDDMMYY(str){
  if(!str) return null;
  let p=str.split("-");
  return new Date(`20${p[2]}`,p[1]-1,p[0]);
}

// -------- CURRENT FY --------
function getCurrentFY(){
  const t=new Date();
  return t.getMonth()>=3?t.getFullYear():t.getFullYear()-1;
}

// -------- FETCH DATA --------
fetch(SHEET_URL)
.then(r=>r.text())
.then(txt=>{
  const json=JSON.parse(txt.substr(47).slice(0,-2));
  const head=json.table.cols.map(c=>c.label);

  json.table.rows.forEach(r=>{
    let o={};
    r.c.forEach((c,i)=>o[head[i]]=c?c.v:"");
    rows.push(o);
  });

  initFYDropdown();
  renderDashboard();
});

// -------- FY DROPDOWN --------
function initFYDropdown(){
  let set=new Set(),sel=document.getElementById("fySelect");
  sel.innerHTML="";
  rows.forEach(r=>{
    let d=parseDDMMYY(r["Date"]);
    if(!d) return;
    let fy=d.getMonth()>=3?d.getFullYear():d.getFullYear()-1;
    set.add(fy);
  });

  let cur=getCurrentFY();
  [...set].sort().reverse().forEach(y=>{
    let o=document.createElement("option");
    o.value=y;
    o.text=`${y}-${String(y+1).slice(2)}`;
    if(y===cur) o.selected=true;
    sel.appendChild(o);
  });
}

// -------- RENDER DASHBOARD --------
function renderDashboard(){
  let fy=parseInt(document.getElementById("fySelect").value);
  let today=new Date();
  let tGen=0,yGen=0,mGen=0,yGenFY=0,prSum=0,prCnt=0;

  let dLab=[],dDat=[];
  let mMap={Apr:0,May:0,Jun:0,Jul:0,Aug:0,Sep:0,Oct:0,Nov:0,Dec:0,Jan:0,Feb:0,Mar:0};
  let mArr=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  rows.forEach(r=>{
    let d=parseDDMMYY(r["Date"]);
    if(!d) return;
    let gen=Number(r["Day Gen"])||0;
    let pr=Number(r["PR"])||0;
    let fyYear=d.getMonth()>=3?d.getFullYear():d.getFullYear()-1;

    if(d.toDateString()===today.toDateString()) tGen+=gen;
    let y=new Date(today); y.setDate(y.getDate()-1);
    if(d.toDateString()===y.toDateString()) yGen+=gen;
    if(d.getMonth()===today.getMonth() && d.getFullYear()===today.getFullYear()) mGen+=gen;
    if(fyYear===fy){ yGenFY+=gen; mMap[mArr[d.getMonth()]]+=gen; }
    if(pr>0){prSum+=pr;prCnt++;}

    if(d.getMonth()===today.getMonth() && d.getFullYear()===today.getFullYear()){
      dLab.push(d.getDate());
      dDat.push(gen);
    }
  });

  todayGen.innerText=tGen.toFixed(1);
  yesterdayGen.innerText=yGen.toFixed(1);
  monthGen.innerText=mGen.toFixed(1);
  yearGen.innerText=yGenFY.toFixed(1);
  avgPR.innerText=(prCnt?prSum/prCnt:0).toFixed(1);

  if(dailyChart) dailyChart.destroy();
  dailyChart=new Chart(document.getElementById("dailyChart"),{
    type:"bar",
    data:{labels:dLab,datasets:[{data:dDat,backgroundColor:"#4caf50"}]},
    options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{display:false}}}}
  });

  if(monthlyChart) monthlyChart.destroy();
  monthlyChart=new Chart(document.getElementById("monthlyChart"),{
    type:"bar",
    data:{labels:Object.keys(mMap),datasets:[{data:Object.values(mMap),backgroundColor:"#2196f3"}]},
    options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{display:false}}}}
  });
}
</script>

</body>
</html>
