<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solar Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;margin:20px;background:#f5f5f5}
.card{display:inline-block;padding:15px 25px;margin:10px;background:#fff;border-radius:6px;
box-shadow:0 2px 6px rgba(0,0,0,0.15)}
.value{font-size:22px;font-weight:bold;color:#2f5597}
canvas{background:#fff;border-radius:8px;padding:10px}
</style>
</head>

<body>

<h2>Shree Hari Fertilizers â€“ Solar Dashboard</h2>

<div class="card">DC Capacity<br><span id="dcCap" class="value">--</span> kWp</div>
<div class="card">Day Gen<br><span id="dayGen" class="value">--</span> MWh</div>
<div class="card">Yesterday Gen<br><span id="yDayGen" class="value">--</span> MWh</div>
<div class="card">Day PR<br><span id="dayPR" class="value">--</span></div>

<br><br>

<canvas id="dailyChart" height="130"></canvas>

<script>
/* ================= GOOGLE SHEET CONFIG ================= */
const SHEET_ID = "1Y3cr91xEEQj86B9hXMYdpp6UU1a33-vlrFcWKkLRujg";
const GID = "0";
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

/* ================= COLUMN INDEX ================= */
const GEN_START = 20;   // Column U
const IRR_START = 52;   // Column BA

fetch(CSV_URL)
.then(res => res.text())
.then(csv => {

  const rows = csv.trim().split("\n").map(r => r.split(","));

  const today = new Date();
  const day = today.getDate();

  const currentMonth = today.toLocaleString('en-US',{month:'short',year:'2-digit'});

  let monthRow = -1;
  rows.forEach((r,i)=>{
    if(r[1] && r[1].includes(currentMonth)) monthRow = i;
  });

  if(monthRow === -1){
    alert("Current month not found in sheet");
    return;
  }

  /* ================= BASIC VALUES ================= */
  const dcCap = parseFloat(rows[monthRow][2]) || 0;

  const dayGen = parseFloat(rows[monthRow][GEN_START + day - 1]) || 0;
  const yDayGen = parseFloat(rows[monthRow][GEN_START + day - 2]) || 0;

  const dayIrr = parseFloat(rows[monthRow][IRR_START + day - 1]) || 0;
  const dayPR = dayIrr ? (dayGen / (dayIrr * dcCap)) * 100 : 0;

  document.getElementById("dcCap").innerText = dcCap.toFixed(0);
  document.getElementById("dayGen").innerText = dayGen.toFixed(2);
  document.getElementById("yDayGen").innerText = yDayGen.toFixed(2);
  document.getElementById("dayPR").innerText = dayPR.toFixed(2) + " %";

  /* ================= DAILY GRAPH DATA ================= */
  let labels=[], gen=[], pr=[];

  for(let i=0;i<31;i++){
    const g = parseFloat(rows[monthRow][GEN_START+i]);
    const irr = parseFloat(rows[monthRow][IRR_START+i]);

    if(!isNaN(g)){
      labels.push(i+1);
      gen.push(g);
      pr.push(irr ? (g/(irr*dcCap))*100 : 0);
    }
  }

  /* ================= CHART ================= */
  new Chart(document.getElementById("dailyChart"),{
    data:{
      labels:labels,
      datasets:[
        {
          type:'bar',
          label:'Day Generation (MWh)',
          data:gen,
          backgroundColor:'#4472c4'
        },
        {
          type:'line',
          label:'PR %',
          data:pr,
          borderColor:'#ed7d31',
          borderWidth:2,
          yAxisID:'y1',
          tension:0.3,
          pointRadius:4
        }
      ]
    },
    options:{
      responsive:true,
      plugins:{
        title:{
          display:true,
          text:'Daily Generation & PR'
        }
      },
      scales:{
        y:{
          title:{display:true,text:'MWh'}
        },
        y1:{
          position:'right',
          grid:{drawOnChartArea:false},
          title:{display:true,text:'PR %'}
        }
      }
    }
  });

});
</script>

</body>
</html>
