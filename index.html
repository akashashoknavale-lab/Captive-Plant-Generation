<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solar Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;padding:20px;}
.grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;}
.box{background:#f6c9a7;padding:12px;text-align:center;border-radius:6px;}
canvas{background:#fff;padding:10px;border-radius:8px;}
</style>
</head>

<body>

<h2 style="text-align:center;">Shree Hari Fertilizers</h2>

<div class="grid">
  <div class="box">Day Gen<br><b id="dayGen">--</b></div>
  <div class="box">Yesterday Gen<br><b id="yGen">--</b></div>
  <div class="box">Month Gen<br><b id="monthGen">--</b></div>
  <div class="box">Year Gen<br><b id="yearGen">--</b></div>
  <div class="box">Day PR<br><b id="dayPR">--</b></div>
  <div class="box">Month PR<br><b id="monthPR">--</b></div>
</div>

<br><br>
<canvas id="dailyChart"></canvas>
<br><br>
<canvas id="monthlyChart"></canvas>

<script>
const sheetURL =
"https://docs.google.com/spreadsheets/d/1Y3cr91xEEQj86B9hXMYdpp6UU1a33-vlrFcWKkLRujg/export?format=csv&gid=861206775";

// âœ… SAFE CSV PARSER
function parseCSV(text){
  const lines = text.trim().split("\n");
  const headers = lines.shift().split(",").map(h=>h.trim());

  return lines.map(l=>{
    const values = l.split(",");
    let obj = {};
    headers.forEach((h,i)=>{
      obj[h] = values[i] ? values[i].trim() : "";
    });
    return obj;
  });
}

fetch(sheetURL)
.then(res => res.text())
.then(csv => {

  const rows = parseCSV(csv);

  const today = new Date();
  const yesterday = new Date();
  yesterday.setDate(today.getDate()-1);

  let dayGen=0, yGen=0, dayPR=0;
  let monthGen=0, yearGen=0, prSum=0, prCount=0;

  let dailyLabels=[], dailyData=[];
  let monthMap={};

  rows.forEach(r=>{
    if(!r["Date"] || !r["Day Gen"]) return;

    const d = new Date(r["Date"]);
    const gen = parseFloat(r["Day Gen"]) || 0;
    const pr = parseFloat(r["PR"]) || 0;

    if(d.toDateString()===today.toDateString()){
      dayGen = gen;
      dayPR = pr;
    }
    if(d.toDateString()===yesterday.toDateString()){
      yGen = gen;
    }

    if(d.getMonth()===today.getMonth() &&
       d.getFullYear()===today.getFullYear()){
      monthGen += gen;
      prSum += pr;
      prCount++;

      dailyLabels.push(d.getDate());
      dailyData.push(gen);
    }

    if(d.getFullYear()===today.getFullYear()){
      yearGen += gen;
    }

    const mKey = d.getFullYear()+"-"+(d.getMonth()+1);
    monthMap[mKey]=(monthMap[mKey]||0)+gen;
  });

  document.getElementById("dayGen").innerText = dayGen.toFixed(2)+" MWh";
  document.getElementById("yGen").innerText = yGen.toFixed(2)+" MWh";
  document.getElementById("monthGen").innerText = monthGen.toFixed(2)+" MWh";
  document.getElementById("yearGen").innerText = yearGen.toFixed(2)+" MWh";
  document.getElementById("dayPR").innerText = dayPR.toFixed(2)+" %";
  document.getElementById("monthPR").innerText =
    prCount ? (prSum/prCount).toFixed(2)+" %" : "0 %";

  new Chart(dailyChart,{
    type:'bar',
    data:{
      labels:dailyLabels,
      datasets:[{label:'Daily Gen (MWh)',data:dailyData}]
    }
  });

  new Chart(monthlyChart,{
    type:'bar',
    data:{
      labels:Object.keys(monthMap),
      datasets:[{label:'Monthly Gen (MWh)',data:Object.values(monthMap)}]
    }
  });

})
.catch(e=>{
  alert("Sheet data load nahi hotay. Publish to web check kar.");
});
</script>

</body>
</html>
